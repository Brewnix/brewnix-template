---
# Security Infrastructure Configuration Tasks

- name: Install security packages
  ansible.builtin.apt:
    name:
      - iptables
      - netfilter-persistent
      - iptables-persistent
      - fail2ban
      - ufw
      - nmap
      - tcpdump
      - wireshark-common
      - openssl
      - ca-certificates
      - curl
      - wget
      - git
    state: present
    update_cache: true

- name: Create security directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /opt/security
    - /opt/security/config
    - /opt/security/scripts
    - /opt/security/logs
    - /opt/security/certs
    - /var/log/security

- name: Configure basic firewall rules
  ansible.builtin.template:
    src: iptables-rules.j2
    dest: /etc/iptables/rules.v4
    mode: '0644'
    owner: root
    group: root
    backup: true
  notify: Reload iptables

- name: Configure fail2ban
  ansible.builtin.template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    mode: '0644'
    owner: root
    group: root
    backup: true
  notify: Restart fail2ban

- name: Enable and start fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: true

- name: Create security monitoring script
  ansible.builtin.template:
    src: security-monitor.sh.j2
    dest: /opt/security/scripts/security-monitor.sh
    mode: '0755'
    owner: root
    group: root

- name: Set up security monitoring cron job
  ansible.builtin.cron:
    name: "Security monitoring"
    minute: "*/5"
    job: "/opt/security/scripts/security-monitor.sh >> /var/log/security/monitor.log 2>&1"
    user: root

- name: Configure network security zones
  ansible.builtin.template:
    src: network-zones.conf.j2
    dest: /opt/security/config/network-zones.conf
    mode: '0644'
    owner: root
    group: root

- name: Set up SSL certificate directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0750'
    owner: root
    group: ssl-cert
  loop:
    - /opt/security/certs/ca
    - /opt/security/certs/server
    - /opt/security/certs/client
    - /opt/security/certs/private

- name: Generate security infrastructure configuration
  ansible.builtin.template:
    src: security-config.yml.j2
    dest: /opt/security/config/infrastructure.yml
    mode: '0644'
    owner: root
    group: root

- name: Create proxmox-firewall integration configuration
  ansible.builtin.template:
    src: proxmox-firewall-integration.yml.j2
    dest: /opt/security/config/proxmox-firewall-integration.yml
    mode: '0644'
    owner: root
    group: root
  when: integrate_proxmox_firewall | default(true)

- name: Display security infrastructure configuration
  ansible.builtin.debug:
    msg: |
      Security Infrastructure Configuration:
      - Firewall Management: {{ security_config.firewall_management_ip }}
      - Security Zone: {{ security_config.security_zone }}
      - Monitoring Retention: {{ security_config.monitoring_retention }}
      - Network Zones: {{ security_zones.keys() | list | join(', ') }}
      - Fail2ban: Enabled
      - Basic Firewall: Configured
      - Security Monitoring: Enabled (5-minute intervals)
      - SSL Certificates: Directory structure created
